# 舵机遥操作控制程序使用说明

## 概述

本项目提供了三个版本的遥操作控制程序，实现学生端舵机实时复制教师端舵机的动作。

## 文件说明

### 1. `06_remote_operation.py` - 完整版
- **特点**: 包含完整的教师端读取和学生端控制功能
- **优点**: 功能完整，支持多线程操作
- **缺点**: 代码较长，可能存在线程同步问题

### 2. `07_remote_operation_simple.py` - 简化版
- **特点**: 依赖现有的模块文件
- **优点**: 代码简洁，易于理解
- **缺点**: 需要确保依赖文件在同一目录

### 3. `08_remote_operation_standalone.py` - 独立版 ⭐ **推荐**
- **特点**: 完全独立，不依赖其他文件
- **优点**: 部署简单，功能完整，界面友好
- **缺点**: 文件较大

## 硬件要求

### 教师端
- 舵机控制器（支持GBot协议）
- 6个舵机（ID: 1-6）
- USB转串口线

### 学生端
- 舵机控制器（支持Dynamixel协议）
- 6个舵机（ID: 1-6）
- USB转串口线

## 软件要求

```bash
pip install pyserial numpy
```

## 配置说明

### 串口配置

在使用前，需要根据实际情况修改串口配置：

```python
# 在main()函数中修改这些参数
TEACHER_PORT = "COM5"  # 教师端串口
STUDENT_PORT = "COM6"  # 学生端串口
SERVO_IDS = [1, 2, 3, 4, 5, 6]  # 舵机ID列表
```

### 如何确定串口号

1. **Windows系统**:
   - 打开设备管理器
   - 查看"端口(COM和LPT)"部分
   - 记录对应的COM端口号

2. **使用Python查看**:
   ```python
   import serial.tools.list_ports
   ports = serial.tools.list_ports.comports()
   for port in ports:
       print(f"{port.device}: {port.description}")
   ```

## 使用步骤

### 1. 硬件连接
1. 将教师端舵机控制器连接到电脑
2. 将学生端舵机控制器连接到电脑
3. 确保所有舵机正确连接并供电

### 2. 软件配置
1. 修改代码中的串口配置
2. 确认舵机ID设置正确

### 3. 运行程序

**推荐使用独立版**:
```bash
python 08_remote_operation_standalone.py
```

### 4. 操作流程
1. 程序启动后会自动连接两端设备
2. 连接成功后开始遥操作
3. 移动教师端舵机，学生端会自动跟随
4. 按 `Ctrl+C` 停止程序

## 程序界面说明

### 连接阶段
```
🤖 舵机遥操作控制程序
📋 功能：学生端舵机实时复制教师端舵机动作
==================================================
⚙️  配置信息:
   教师端串口: COM5
   学生端串口: COM6
   舵机ID: [1, 2, 3, 4, 5, 6]

正在连接教师端 (COM5)...
✅ 教师端连接成功
正在连接学生端 (COM6)...
✅ 学生端连接成功
正在启用学生端舵机扭矩...
  ✅ 舵机1扭矩启用成功
  ✅ 舵机2扭矩启用成功
  ...
🎉 所有设备连接成功！
```

### 运行阶段
```
🚀 开始遥操作
📡 学生端将实时复制教师端动作...
⏹️  按 Ctrl+C 停止

[15.2s 9.8Hz] S1:45.2°→45.2° | S2:保持0.0° | S3:-30.1°→-30.1° | S4:保持0.0° | S5:保持0.0° | S6:保持0.0°
```

### 结束阶段
```
⏹️  用户中断操作

📊 操作统计:
  运行时间: 25.3秒
  循环次数: 253
  平均频率: 10.0Hz
  成功次数: 156
  失败次数: 2
  成功率: 98.7%

🔌 已断开所有连接
👋 程序结束
```

## 参数调整

### 角度映射

默认情况下，教师端角度直接映射到学生端，范围限制在-90°到90°：

```python
# 在control_student_servos方法中
mapped_angle = max(-90, min(90, angle))
```

如需自定义映射关系，可以修改这部分代码。

### 更新阈值

为减少不必要的通信，只有角度变化超过阈值才会更新：

```python
# 在control_student_servos方法中
if angle_diff > 3.0:  # 角度变化超过3度才更新
```

可以根据需要调整这个阈值。

### 控制频率

默认控制频率为10Hz：

```python
target_cycle_time = 0.1  # 10Hz
```

可以根据需要调整频率，但不建议超过20Hz。

## 故障排除

### 常见问题

1. **串口连接失败**
   - 检查串口号是否正确
   - 确认设备已正确连接
   - 检查是否有其他程序占用串口

2. **舵机不响应**
   - 检查舵机供电
   - 确认舵机ID设置正确
   - 检查舵机连接线

3. **角度读取失败**
   - 检查教师端设备连接
   - 确认波特率设置正确
   - 检查通信协议是否匹配

4. **控制延迟较大**
   - 降低控制频率
   - 增大角度更新阈值
   - 检查串口通信质量

### 调试模式

如需调试，可以在代码中添加更多打印信息：

```python
# 在read_angle方法中添加
print(f"读取舵机{motor_id}角度: {angle}")

# 在set_servo_angle方法中添加
print(f"设置舵机{servo_id}角度: {angle}")
```

## 技术说明

### 通信协议

- **教师端**: GBot协议，波特率230400
- **学生端**: Dynamixel协议，波特率1000000

### 角度转换

- **教师端**: 原始位置值通过偏移和分辨率转换为角度
- **学生端**: 角度映射到位置值范围1024-3072

### 性能优化

- 使用角度变化阈值减少通信量
- 控制循环频率避免过载
- 异常处理确保程序稳定性

## 扩展功能

### 添加新舵机

修改`SERVO_IDS`列表即可：

```python
SERVO_IDS = [1, 2, 3, 4, 5, 6, 7, 8]  # 添加舵机7和8
```

### 自定义角度映射

可以为不同舵机设置不同的映射关系：

```python
def custom_angle_mapping(servo_id, teacher_angle):
    if servo_id == 1:
        return teacher_angle * 0.5  # 舵机1减半
    elif servo_id == 2:
        return -teacher_angle  # 舵机2反向
    else:
        return teacher_angle  # 其他舵机直接映射
```

### 数据记录

可以添加数据记录功能：

```python
import csv
import datetime

# 在操作循环中添加
with open('servo_data.csv', 'a', newline='') as f:
    writer = csv.writer(f)
    timestamp = datetime.datetime.now()
    writer.writerow([timestamp] + list(teacher_angles.values()))
```

## 联系支持

如遇到问题，请检查：
1. 硬件连接是否正确
2. 软件配置是否匹配
3. 参考故障排除部分

建议使用 `08_remote_operation_standalone.py` 版本，它提供了最好的用户体验和错误提示。